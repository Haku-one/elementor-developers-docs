<div align="center">
    <img width="300" src="https://developers.elementor.com/docs/favicon.png" alt="Elementor Logo">
</div>

# Elementor Developers Docs

Resources and tutorials for Elementor developers.

## Documentation

Check out our developer resources:

* [Elementor Developers](https://developers.elementor.com/)
* [Elementor Developers Blog](https://developers.elementor.com/blog/)
* [Elementor Developers Docs](https://developers.elementor.com/docs/)

# Система скидок по объему для WooCommerce

Полная система скидок по объему для WooCommerce с поддержкой простых и вариативных товаров. Все функции интегрированы в один файл без внешних зависимостей.

## Основные возможности

- ✅ Поддержка простых и вариативных товаров
- ✅ Настраиваемые диапазоны скидок (до 7 правил)
- ✅ Автоматическое применение скидок в корзине
- ✅ AJAX добавление в корзину с отображением скидок
- ✅ Интеграция с мини-корзиной
- ✅ Форматирование цен (рубли вместо символа ₽)
- ✅ Административная панель для настройки скидок
- ✅ Все CSS и JavaScript интегрированы в шорткод

## Установка

1. Загрузите файл `woocommerce-volume-discounts.php` в папку с темой или плагинами
2. Подключите файл в `functions.php` вашей темы:

```php
require_once get_template_directory() . '/woocommerce-volume-discounts.php';
```

Или создайте плагин, добавив заголовок:

```php
<?php
/*
Plugin Name: WooCommerce Volume Discounts
Description: Система скидок по объему для WooCommerce
Version: 1.0
*/

// Затем весь код из файла woocommerce-volume-discounts.php
```

## Использование шорткода

### Базовое использование

```
[volume_discount_controls]
```

Автоматически определяет текущий товар на странице товара.

### С указанием ID товара

```
[volume_discount_controls product_id="123"]
```

### Полная настройка

```
[volume_discount_controls 
    product_id="123" 
    button_text="Купить сейчас" 
    button_class="my-custom-button" 
    show_price="yes" 
    show_discounts="yes"]
```

### Параметры шорткода

- `product_id` - ID товара (по умолчанию: текущий товар)
- `button_text` - Текст кнопки (по умолчанию: "Добавить в корзину")
- `button_class` - CSS класс кнопки (по умолчанию: "elementor-button")
- `show_price` - Показывать цену (yes/no, по умолчанию: yes)
- `show_discounts` - Показывать таблицу скидок (yes/no, по умолчанию: yes)

## Настройка скидок

### В админке товара

1. Перейдите в редактирование товара
2. В разделе "Данные товара" найдите "Настройки скидок по объему"
3. Настройте до 7 правил скидок:
   - **От (шт)** - минимальное количество
   - **До (шт)** - максимальное количество (для последнего правила не заполняется)
   - **Скидка (%)** - процент скидки

### Для вариативных товаров

Скидки можно настроить как для родительского товара (применятся ко всем вариациям), так и для отдельных вариаций.

### Скидки по умолчанию

Если скидки не настроены для товара, используются следующие значения:

- 5-10 шт: 3%
- 11-20 шт: 6%
- 21-59 шт: 12.5%
- 60-119 шт: 45%
- 120-239 шт: 46.5%
- 240-799 шт: 48%
- 800+ шт: 50%

## Возможности шорткода

### Для простых товаров

- Поле количества с кнопками +/-
- Кнопка добавления в корзину
- Отображение текущей цены
- Динамическое обновление информации о скидке
- Таблица доступных скидок

### Для вариативных товаров

- Выбор атрибутов товара
- Динамическое обновление цены при выборе вариации
- Кнопка сброса выбора
- Все возможности простых товаров после выбора вариации

### AJAX функциональность

- Добавление в корзину без перезагрузки страницы
- Обновление мини-корзины
- Уведомления об успешном добавлении
- Обработка ошибок

## Стилизация

Все стили генерируются автоматически и привязаны к уникальному ID каждого экземпляра шорткода. Основные CSS классы:

- `.volume-discount-controls` - основной контейнер
- `.quantity-controls` - блок управления количеством
- `.volume-discount-info` - информация о скидке
- `.volume-discount-table` - таблица скидок
- `.cart-notification` - уведомления

## Хуки и фильтры

### Доступные фильтры

- `wc_price` - форматирование цен
- `woocommerce_get_price_html` - HTML цены товара
- `woocommerce_cart_item_price` - цена в корзине
- `woocommerce_cart_item_subtotal` - подытог в корзине

### Доступные действия

- `woocommerce_before_calculate_totals` - применение скидок
- `woocommerce_product_options_pricing` - поля в админке
- `woocommerce_process_product_meta` - сохранение настроек

## AJAX обработчики

- `get_volume_discount_info` - получение информации о скидке
- `add_to_cart_with_volume_discount` - добавление товара в корзину

## Безопасность

- Все входящие данные проходят санитизацию через `wc_clean()` и `sanitize_text_field()`
- Проверка nonce для AJAX запросов
- Валидация прав доступа
- Защита от прямого доступа к файлу

## Совместимость

- WordPress 5.0+
- WooCommerce 3.0+
- PHP 7.4+
- Поддержка Elementor
- Совместимость с кешированием

## Возможные проблемы и решения

### Скидки не применяются

1. Убедитесь, что WooCommerce активен
2. Проверьте настройки скидок в админке товара
3. Очистите кеш

### Не работает AJAX

1. Проверьте, что jQuery подключен
2. Убедитесь в отсутствии конфликтов JavaScript
3. Проверьте консоль браузера на ошибки

### Проблемы со стилями

1. Проверьте, что стили не перезаписываются темой
2. Используйте более специфичные селекторы при необходимости
3. Добавьте `!important` для критичных стилей

## Примеры использования

### На странице товара

```php
// В шаблоне single-product.php
echo do_shortcode('[volume_discount_controls]');
```

### В Elementor

Добавьте виджет "Шорткод" и вставьте:
```
[volume_discount_controls button_class="elementor-button-link elementor-button-primary"]
```

### Для конкретного товара в любом месте

```
[volume_discount_controls product_id="123" show_price="no"]
```

## Журнал изменений

### Версия 1.0
- Первый релиз
- Поддержка простых и вариативных товаров
- Интеграция всего кода в шорткод
- AJAX функциональность
- Административная панель
