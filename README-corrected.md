# Система скидок по объему для WooCommerce (Исправленная версия)

## Что исправлено

✅ **Правильная работа с вариативными товарами** - используем нативные хуки WooCommerce  
✅ **Не ломает мини-корзину** - корректное использование фрагментов WooCommerce  
✅ **Объектно-ориентированный подход** - весь код в одном классе  
✅ **Правильные хуки WooCommerce** - используем стандартные методы  
✅ **Безопасность AJAX** - nonce проверки для всех запросов  
✅ **Сохранены кастомные поля** - 7 настраиваемых правил скидок  

## Установка

```php
// В functions.php вашей темы
require_once get_template_directory() . '/woocommerce-volume-discounts-corrected.php';
```

## Использование шорткода

### Базовое использование
```
[volume_discount_controls]
```

### С параметрами
```
[volume_discount_controls 
    product_id="123" 
    button_text="Купить сейчас" 
    button_class="btn btn-primary" 
    show_price="yes" 
    show_discounts="yes"]
```

## Параметры шорткода

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `product_id` | ID товара | Текущий товар |
| `button_text` | Текст кнопки | "Добавить в корзину" |
| `button_class` | CSS класс кнопки | "button" |
| `show_price` | Показывать цену | "yes" |
| `show_discounts` | Показывать таблицу скидок | "yes" |

## Ключевые улучшения

### 1. Правильная работа с вариативными товарами
- Используем `get_available_variations()` WooCommerce
- Корректный поиск подходящей вариации
- Обновление цены при выборе вариации
- Правильная передача атрибутов в корзину

### 2. Корректная интеграция с корзиной
- Используем стандартные фрагменты WooCommerce
- Не ломаем мини-корзину
- Правильное обновление после добавления товара

### 3. Безопасность
- Все AJAX запросы проверяются через nonce
- Санитизация всех входящих данных
- Проверка прав доступа

### 4. Производительность
- Скрипты загружаются только на нужных страницах
- Минимальная нагрузка на сервер
- Кеширование настроек скидок

## Как работает система

### Для простых товаров:
1. Пользователь выбирает количество
2. Система рассчитывает скидку
3. Показывает информацию о скидке
4. При добавлении в корзину применяется скидка

### Для вариативных товаров:
1. Пользователь выбирает атрибуты товара
2. Система находит подходящую вариацию
3. Показывает цену и информацию о скидке
4. При добавлении передает все атрибуты

## Настройка скидок в админке

### Для обычных товаров:
1. Перейдите в редактирование товара
2. В разделе "Данные товара" найдите "Настройки скидок по объему"
3. Заполните до 7 правил скидок

### Для вариативных товаров:
- Скидки настраиваются для родительского товара
- Применяются ко всем вариациям
- Можно настроить индивидуальные скидки для каждой вариации

## Технические детали

### Используемые хуки WooCommerce:
- `woocommerce_before_calculate_totals` - применение скидок
- `woocommerce_get_item_data` - отображение скидки в корзине
- `woocommerce_cart_item_name` - отображение в мини-корзине
- `woocommerce_add_to_cart_fragments` - обновление фрагментов

### AJAX обработчики:
- `get_volume_discount_info` - получение информации о скидке
- `add_to_cart_volume_discount` - добавление товара в корзину

### CSS классы:
- `.volume-discount-controls` - основной контейнер
- `.quantity-controls` - управление количеством
- `.volume-discount-info-container` - информация о скидке
- `.volume-discount-table` - таблица скидок

## Скидки по умолчанию

Если не настроены индивидуальные скидки, используются:

- 5-10 шт: 3%
- 11-20 шт: 6%
- 21-59 шт: 12.5%
- 60-119 шт: 45%
- 120-239 шт: 46.5%
- 240-799 шт: 48%
- 800+ шт: 50%

## Совместимость

- ✅ WordPress 5.0+
- ✅ WooCommerce 3.0+
- ✅ PHP 7.4+
- ✅ Все современные темы
- ✅ Elementor и другие конструкторы

## Отладка

### Если не работают скидки:
1. Проверьте настройки в админке товара
2. Убедитесь, что WooCommerce активен
3. Очистите кеш

### Если не работает AJAX:
1. Откройте консоль браузера
2. Проверьте наличие ошибок JavaScript
3. Убедитесь, что jQuery подключен

### Если не отображается шорткод:
1. Проверьте ID товара
2. Убедитесь, что товар существует
3. Проверьте права доступа

## Пример интеграции в тему

```php
// В single-product.php
if (function_exists('WC_Volume_Discounts')) {
    echo do_shortcode('[volume_discount_controls]');
}
```

## Кастомизация стилей

```css
.volume-discount-controls {
    /* Ваши стили */
}

.volume-discount-info {
    background: #e3f2fd;
    border: 1px solid #2196f3;
}

.volume-discount-table {
    /* Стили таблицы скидок */
}
```